"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _regenerator=require("babel-runtime/regenerator"),_regenerator2=_interopRequireDefault(_regenerator),_asyncToGenerator2=require("babel-runtime/helpers/asyncToGenerator"),_asyncToGenerator3=_interopRequireDefault(_asyncToGenerator2),_promise=require("babel-runtime/core-js/promise"),_promise2=_interopRequireDefault(_promise),_express=require("express"),_express2=_interopRequireDefault(_express),_axios=require("axios"),_axios2=_interopRequireDefault(_axios),_classModel=require("./classModel.js"),_classModel2=_interopRequireDefault(_classModel),_BatchRequests=require("../ExternalApis/BatchRequests"),_Arrays=require("../Helpers/Arrays");function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}require("dotenv").config();var Router=_express2.default.Router(),trelloKey=process.env.TRELLO_KEY,trelloToken=process.env.TRELLO_TOKEN,auth="?key="+trelloKey+"&token="+trelloToken;Router.get("/:userID",function(a,b){var c=a.params.userID;_classModel2.default.find({userID:c}).populate("projects").lean().then(function(a){for(var c=0,d=0,e=[],f=0;f<a.length;f++)for(var k,l=0;l<a[f].projects.length;l++)k=a[f].projects[l].trelloID,c=f,d=l,e.push((0,_BatchRequests.fetchClassProgress)(k));var g=e.length,h=g;_promise2.default.all(e).then(function(c){for(var k=0;k<a.length&&!(0===h);k++)for(var d=a[k].projects,e=0;e<d.length&&!(0===h);e++){var f=c[g-h],i=f.circ,j=f.completeness;d[e].circ=i,d[e].completeness=j,h--}b.status(200).json({classes:a})}).catch(function(){return b.send("error")})}).catch(function(){return b.send("error")})}),Router.post("/",function(a,b){var c=a.body,d=c.userID,e=(0,_classModel2.default)(c);e.save().then(function(){_classModel2.default.find({userID:d}).populate("projects").then(function(a){return b.status(200).json({classes:a})}).catch(function(){return b.send("error")})}).catch(function(){return b.send("error")})}),Router.get("/projects/:id",function(){var a=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function a(b,c){var d;return _regenerator2.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:d=b.params.id,_classModel2.default.findById(d).populate("projects").then(function(a){for(var b,d=a.projects,e=[],f=0;f<d.length;f++)b=d[f].trelloID,e.push(_axios2.default.get("https://api.trello.com/1/boards/"+b+"/members"+auth));_axios2.default.all(e).then(function(a){for(var b,d=[],e=0;e<a.length;e++)b=a[e].data,d.push(b);c.status(200).json({results:d})}).catch(function(){return c.json({error:"error"})})}).catch(function(){c.status(500).json({msg:"we cant display this class "})});case 2:case"end":return a.stop();}},a,void 0)}));return function(){return a.apply(this,arguments)}}()),Router.put("/:userID/:id",function(a,b){var c=a.params,d=c.userID,e=c.id;_classModel2.default.findByIdAndUpdate(e,a.body,{new:!0}).then(function(){_classModel2.default.find({userID:d}).populate("projects").then(function(a){return b.status(200).json({classes:a})}).catch(function(){return b.send("error")})}).catch(function(){b.status(500).json({msg:"... not able to update your class"})})}),Router.delete("/:id/:userID",function(a,b){var c=a.params,d=c.id,e=c.userID;_classModel2.default.findById(d).remove().then(function(){_classModel2.default.find({userID:e}).populate("projects").then(function(a){return b.status(200).json({classes:a})}).catch(function(){return b.send("error")})}).catch(function(){b.send("error")})}),exports.default=Router;